### 모든별 키즈 - 구현 계획서 (미구현/개선 항목 정리)

본 문서에는 `fghfghfgh` 파일의 27개 요구사항을 기능 카테고리별로 구조화하고, 구현 포인트, 데이터/보안 고려사항, 수락 기준을 정리했습니다. 우선순위는 P0(긴급) > P1(높음) > P2(보통)으로 표기합니다.

### 결제/구독/인터뷰권
- P0: 1개월권 시 인터뷰권 2회 부여 보정 (요구1)
  - 구현: `payment-checkout/page.tsx`에서 1개월권 구매 시 `user-subscription-status.remainingInterviews = 2` 설정 확인 및 사용자 `users.interviewTokens += 2` 동기화 정책 확정
  - 보안: `firestore.rules`에서 구독/토큰 필드 업데이트 권한 경로 재검토
  - 수락 기준: 1개월권 결제 완료 후 학부모 계정에서 인터뷰권 2회가 즉시 반영, 채팅 첫 메시지 차감 동작 정상

- P1: 추가 인터뷰권 수동 부여(관리자) (요구2)
  - 구현: 관리자 UI에 "인터뷰권 +1" 액션 추가, 서버 없이 Firestore 트랜잭션으로 `users.interviewTokens` 증가
  - 보안: 관리자만 허용되도록 규칙 강화 또는 Cloud Function 경유(선택)
  - 수락 기준: 관리자에서 특정 사용자에게 +1 부여 가능, 감사 로그(필드) 기록

- P1: 구독이 있어야 주요 액션 활성화 (요구5, 17 일부)
  - 구현: `선생님께 요청하기`/`선생님 둘러보기` 버튼 가드. 미보유 시 비활성 스타일 + 안내 문구(기존 회색 버튼 스타일 유지)
  - 수락 기준: 구독 없음 → 버튼 비활성 및 안내, 구독 있음 → 정상 동작

- P1: 치료사 미응답 시 인터뷰권 복구 (요구14)
  - 구현: 일정 시간 내 첫 응답 없으면 `handleChatCancellation` 호출로 복구. 수동 종료 시에도 복구 트리거 제공
  - 수락 기준: 학부모가 보낸 뒤 치료사 무응답 → 채팅 종료 시 인터뷰권 자동 복구 표시

### 인증/온보딩/약관
- P1: 회원가입 직후 사용자 타입 분류 즉시 반영 (요구4)
  - 구현: `AuthContext`에서 로그인 이벤트 직후 Firestore `users.userType` fetch 보장, SSR/CSR 캐싱 무효화
  - 수락 기준: 새로고침 없이 즉시 역할 기반 UI 반영

- P1: 약관 동의 미체크 시 진행 차단 (요구6)
  - 구현: 회원가입 폼의 필수 동의 체크 검증. 디자인 파일 반영은 별도(사장님 전달 시)
  - 수락 기준: 필수 미체크 → 제출 불가 및 메시지 노출

### 요청 게시판/지원/프로필
- P0: 게시글당 지원 최대 2명 제한 엄정화 & 중복 방지 (요구11~12)
  - 구현: 이미 `lib/applications.ts` 트랜잭션 존재. 프론트 중복 제출 방지, 실시간 카운트 표기 정확화
  - 수락 기준: 2명 초과 시 서버에서 거절, 중복 클릭/중복 지원 불가, 표시값 정확

- P1: 학부모가 본인 게시글에 지원 차단 (요구10)
  - 구현: 지원 버튼 조건에서 `currentUser.uid !== post.authorId` 검증 및 경고 메시지
  - 수락 기준: 학부모 자신의 글에서 지원 버튼 동작하지 않고 경고 노출

- P1: 치료사 상세/수정 플로우 개선 (요구7, 9, 21, 23, 49~52)
  - 구현: 프로필/게시글 끌어올림 수정 팝업 별도, 치료사 프로필 단건 상태에서 재등록 방지, 심사 재요청 안내
  - 수락 기준: 동일 디자인의 수정 팝업 구현, 중복 등록 방지, 수정 후 재심사 고지

- P2: 끌어올림 대기시간 표시 개선 (요구8)
  - 구현: 남은 시간(시:분) 계산 표시
  - 수락 기준: 24시간 미경과 시 남은 시간이 정확히 표기

### 채팅/상태 표시/목록 UX
- P1: 치료사 계정에서 지원한 게시글에는 1:1 채팅 버튼 비활성 + 경고 (요구13)
  - 구현: 이미 지원된 경우 버튼 회색화 및 경고 팝업
  - 수락 기준: 동일 게시글 재지원·채팅 유도 불가, 명확한 안내

- P1: 매칭 상태 전이("매칭중"→"인터뷰중"→"매칭완료") (요구15, 73)
  - 구현: 채팅/승낙 이벤트 기반으로 게시글/채팅방 상태 필드 업데이트, 마이페이지/목록 배지 동기화
  - 수락 기준: 실제 흐름에 맞춰 상태가 일관되게 반영되고 UI 배지 표기 정확

- P2: 채팅 목록 더보기/무한 스크롤 및 유지 (요구72)
  - 구현: `subscribeToUserChatRooms` 페이지네이션/무한스크롤 적용
  - 수락 기준: 더보기로 누적 표시, 스크롤 상태 유지

### 접근 제어/가시성
- P1: 다른 치료사 계정도 게시글 목록 가시화 (요구16)
  - 구현: 역할별 필터/보안 규칙 확인 후 목록은 가시, 액션은 역할별 제한
  - 수락 기준: 치료사 계정에서 게시글 노출, 권한없는 액션은 제한

- P1: 치료사 등록/검토/구독과 노출 조건 연계 (요구17, 20)
  - 구현: 등록 심사 완료 + 구독 보유 시만 `선생님 둘러보기` 노출 및 카드 자동 구성
  - 수락 기준: 조건 충족 시 자동 노출, 미충족 시 안내

- P1: 학부모는 치료사 상세 제한적 가시성, 관리자 전면 가시 (요구46~47, 51~52, 54)
  - 구현: 역할별 필드 마스킹/비공개 처리
  - 수락 기준: 학부모는 제한 정보만, 관리자는 전체 확인 가능

### 리뷰/후기
- P1: 치료사는 후기 작성 불가 (요구25)
  - 구현: 역할별 UI/서버 검증
  - 수락 기준: 치료사 계정에서 작성 진입 불가

- P1: 매칭완료 상태에서만 후기 작성 가능 (요구26)
  - 구현: 후기 작성 버튼 조건에 상태 검증 추가, 마이페이지의 후기 작성/관리 페이지 라벨 변경
  - 수락 기준: 상태 충족 시에만 작성 가능, 네이밍 업데이트 완료

- P2: 연동된 치료사 선택 후 후기 작성 팝업 및 프로필 반영 (요구27, 67~68, 74 일부)
  - 구현: 연동 관계 리스트업, 선택 팝업, 작성 시 치료사 프로필/리스트에 반영
  - 수락 기준: 선택-작성-반영이 자연스럽게 동작

### Toss Payments(추후)
- P2: 토스페이먼츠 테스트 키 연동 (요구6)
  - 구현: 위젯/서버 검증 흐름 설계(현재 무통장 로직과 공존), 환경변수/보안 규칙 보완
  - 수락 기준: 테스트 결제 승인/실패 플로우 확인 가능

### 내비게이션/레이아웃
- P2: 치료사 신청 페이지 좌측 사이드 항목 노출 보정 (요구24, 60)
  - 구현: 페이지 레이아웃 공통화로 사이드 항목 유지
  - 수락 기준: 두 페이지 모두 동일한 사이드 항목 노출

### 구현 세부 포인트(파일/모듈)
- 구독/토큰: `src/app/payment-checkout/page.tsx`, `src/lib/interviewTokens.ts`, `src/lib/chat.ts`, `firestore.rules`
- 지원/게시판: `src/lib/applications.ts`, `src/components/request/RequestBoardFirebase.tsx`
- 채팅/알림: `src/components/chat/OneOnOneChat.tsx`, `src/lib/chat.ts`, `src/lib/notifications.ts`
- 인증/세션: `src/contexts/AuthContext.tsx`, `src/lib/auth.ts`, `src/app/ClientProviders.tsx`
- 관리자: `src/components/admin/**`, `src/hooks/useAdminStats.ts`
- 리뷰: `src/components/reviews/**`

### 마이그레이션/보안 체크리스트
- Firestore 규칙: 구독/토큰/상태 전이/후기 작성 권한 경로 강화
- 데이터 마이그레이션: 기존 사용자에 대한 인터뷰권 초기화/보정 스크립트(간단한 API route 또는 일회성 스크립트)

### 제안되는 작업 배치(스프린트)
- 스프린트 1(P0/P1 핵심)
  1) 인터뷰권 2회 부여 보정, 추가 부여(관리자), 미응답 복구
  2) 지원 제한(최대 2명/중복 방지/본인 글 지원 차단) 안정화
  3) 역할/구독 기반 접근 가드(요청/둘러보기 버튼)
  4) 매칭 상태 전이 및 표시

- 스프린트 2(P1/P2 개선)
  1) 치료사 상세/수정 플로우, 끌어올림 남은시간 표시
  2) 채팅 목록 더보기/상태 배지 정비
  3) 후기 작성 조건/흐름 완성
  4) 치료사 신청/노출 조건 연계 마감

- 스프린트 3(선택/확장)
  1) 토스 테스트 키 연동
  2) 관리자 감사 로그/지표 보강


