rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // 헬퍼 함수들
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth != null && 
             firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid));
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwnerOrAdmin(userId) {
      return isOwner(userId) || isAdmin();
    }
    
    // 최근 활동 검증
    function hasRecentActivity() {
      return request.auth != null && request.auth.token.auth_time > timestamp.date() - duration.value(30, 'd');
    }
    
    // 신고 파일 전용 검증 (더 관대한 조건)
    function isValidReportFile() {
      return request.resource.contentType in [
        'image/jpeg', 'image/png', 'image/gif', 'image/webp',
        'application/pdf', 'application/msword', 
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'text/plain'
      ] && request.resource.size < 15 * 1024 * 1024 && // 15MB 제한
      request.resource.size > 100; // 최소 100bytes (매우 작은 파일 방지)
    }
    
    // 업무시간 검증 (DDoS 방지)
    function isBusinessHours() {
      return request.time.dayOfWeek() >= 1 && request.time.dayOfWeek() <= 7 &&
             request.time.hours() >= 6 && request.time.hours() < 24;
    }
    
    // 이미지 파일 검증
    function isValidImageType() {
      return request.resource.contentType in [
        'image/jpeg', 'image/png', 'image/gif', 'image/webp'
      ] && request.resource.size < 10 * 1024 * 1024 && // 10MB 제한
      request.resource.size > 1024; // 최소 1KB (빈 파일 방지)
    }
    
    // 프로필 이미지 전용 검증 (더 엄격)
    function isValidProfileImage() {
      return request.resource.contentType in [
        'image/jpeg', 'image/png'
      ] && request.resource.size < 5 * 1024 * 1024 && // 5MB 제한
      request.resource.size > 10 * 1024; // 최소 10KB
    }
    
    // 비디오 파일 검증
    function isValidVideoType() {
      return request.resource.contentType in [
        'video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/webm'
      ] && request.resource.size < 100 * 1024 * 1024 && // 100MB 제한
      request.resource.size > 100 * 1024; // 최소 100KB
    }
    
    // 문서 파일 검증
    function isValidDocumentType() {
      return request.resource.contentType in [
        'application/pdf', 'application/msword', 
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'image/jpeg', 'image/png' // 스캔된 문서
      ] && request.resource.size < 20 * 1024 * 1024 && // 20MB 제한
      request.resource.size > 1024; // 최소 1KB
    }
    
    // 사용자 프로필 이미지
    match /profile-images/{userId}/{filename} {
      // 본인만 업로드/수정/삭제 가능
      allow create, update, delete: if isOwner(userId) && 
                                       isValidProfileImage() && 
                                       hasRecentActivity();
      
      // 모든 인증된 사용자가 읽기 가능
      allow read: if isAuthenticated();
    }
    
    // 자격증/면허증 파일
    match /certificates/{userId}/{filename} {
      // 본인과 관리자만 업로드/수정/삭제 가능
      allow create, update, delete: if (isOwner(userId) || isAdmin()) && 
                                       isValidDocumentType() && 
                                       hasRecentActivity();
      
      // 승인된 치료사의 자격증은 다른 사용자도 읽기 가능 (공개)
      allow read: if isAuthenticated();
    }
    
    // 채팅 메시지 첨부파일
    match /chat-files/{chatId}/{filename} {
      // 채팅 참여자만 업로드/읽기 가능
      allow create, read: if isAuthenticated() && 
                             (isValidImageType() || isValidDocumentType()) &&
                             hasRecentActivity();
      
      // 업로드한 본인과 관리자만 삭제 가능
      allow delete: if isAuthenticated();
    }
    
    // 게시글 첨부파일 (posts용)
    match /posts/{postId}/attachments/{filename} {
      // 게시글 작성자만 업로드/삭제 가능
      allow create, delete: if isAuthenticated() && 
                               (isValidImageType() || isValidDocumentType()) &&
                               hasRecentActivity() &&
                               // 첨부파일 크기 제한 (각 파일 10MB)
                               request.resource.size < 10 * 1024 * 1024;
      
      // 모든 인증된 사용자가 읽기 가능 (공개 게시글)
      allow read: if isAuthenticated();
      
      // 관리자도 삭제 가능
      allow delete: if isAdmin();
    }
    
    // 치료사 프로필 사진 (상세 프로필용)
    match /teacher-profiles/{userId}/profile-image/{filename} {
      // 치료사 본인만 업로드/수정/삭제 가능
      allow create, update, delete: if isAuthenticated() && 
                                       isOwner(userId) &&
                                       isValidProfileImage() &&
                                       hasRecentActivity();
      
      // 모든 인증된 사용자가 읽기 가능 (공개 프로필)
      allow read: if isAuthenticated();
    }
    
    // 치료사 소개 비디오 (상세 프로필용)
    match /teacher-profiles/{userId}/introduction-video/{filename} {
      // 치료사 본인만 업로드/수정/삭제 가능
      allow create, update, delete: if isAuthenticated() && 
                                       isOwner(userId) &&
                                       isValidVideoType() &&
                                       hasRecentActivity() &&
                                       // 비디오 파일 크기 제한 (50MB)
                                       request.resource.size < 50 * 1024 * 1024;
      
      // 모든 인증된 사용자가 읽기 가능 (공개 소개 비디오)
      allow read: if isAuthenticated();
    }
    
    // 치료사 인증서/자격증 (상세 프로필용)
    match /teacher-profiles/{userId}/certifications/{filename} {
      // 치료사 본인만 업로드/수정/삭제 가능
      allow create, update, delete: if isAuthenticated() && 
                                       isOwner(userId) &&
                                       isValidDocumentType() &&
                                       hasRecentActivity() &&
                                       // 인증서 파일 크기 제한 (10MB)
                                       request.resource.size < 10 * 1024 * 1024;
      
      // 치료사 본인과 관리자만 읽기 가능
      allow read: if isAuthenticated() && 
                     (isOwner(userId) || isAdmin());
    }
    
    // 후기 첨부 파일 (학부모 후기용)
    match /teacher-reviews/{reviewId}/attachments/{filename} {
      // 후기 작성자만 업로드 가능
      allow create: if isAuthenticated() && 
                       isValidImageType() &&
                       hasRecentActivity() &&
                       // 후기 첨부파일 크기 제한 (5MB)
                       request.resource.size < 5 * 1024 * 1024;
      
      // 모든 인증된 사용자가 읽기 가능 (공개 후기)
      allow read: if isAuthenticated();
      
      // 관리자만 삭제 가능
      allow delete: if isAdmin();
    }
    
    // 직거래 신고 증빙 파일 - 실용적인 운영용 보안 규칙
    match /reports/{reportId}/evidence/{filename} {
      // 증빙 파일 업로드: 누구나 가능 (익명 신고 지원), 기본적인 파일 검증
      allow create: if isValidReportFile();
      
      // 증빙 파일 읽기: 특정 관리자 이메일 또는 관리자 컬렉션에 등록된 사용자
      allow read: if isAuthenticated() && 
                     (request.auth.token.email == 'dudals7334@naver.com' ||
                      firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid)));
      
      // 증빙 파일 수정: 허용하지 않음 (원본 보존)
      allow update: if false;
      
      // 증빙 파일 삭제: 특정 관리자만 가능 (조사 완료 후)
      allow delete: if isAuthenticated() && 
                       (request.auth.token.email == 'dudals7334@naver.com' ||
                        firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid)));
    }
    
    // 임시 파일 (만료시간 포함)
    match /temp/{ts}/{filename} {
      // 인증된 사용자만 업로드 가능 (24시간 후 자동 삭제)
      allow create: if isAuthenticated() && 
                       (isValidImageType() || isValidDocumentType()) &&
                       hasRecentActivity() &&
                       int(ts) > 0; // 타임스탬프 검증
      
      // 모든 사용자가 읽기 가능 (임시 공유용)
      allow read: if true;
      
      // 24시간 후 자동 삭제 (또는 업로드한 본인이 삭제 가능)
      allow delete: if isAuthenticated() && 
                       (request.time.toMillis() > int(ts) + 86400000);
    }
    
    // 기본적으로 모든 다른 경로는 거부
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
